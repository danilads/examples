<!DOCTYPE html> 
<html>
<head>
	<meta charset="utf-8" />
	<title></title>
</head>
<body>
<div>Базу можно посмотреть в консоли - Application !но нужно после каждого изменения обновлять</div>
<br/>
<div>
  <div>01 УДАЛИТЬ БАЗУ</div>
  <div><input type="input" id="id1" placeholder="название базы"/><button onclick="deleteBase()">удалить</button></div>
</div>
<br/>
<div>
  <div>02 СТАНДАРТНЫЕ ОПЕРАЦИИ a) (создание / открытие)</div>
  <div><input type="input" id="id2a1" placeholder="название базы"/><button onclick="getNameAndVersion()">создание / открытие</button></div>
</div>
<br/>
<div>
  <div>02 СТАНДАРТНЫЕ ОПЕРАЦИИ b) (закрыть базу) нужно чтобы удалить (базу / хранилище)</div>
  <div><input type="input" id="id2b1" placeholder="название базы"/><button onclick="closeBase()">закрыть</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ a) создать хранилище в уже созданной базе (чтобы создать хранилище нужно обновить версию базы) </div>
  <div><input type="input" id="id3a1" placeholder="название базы"/><input type="input" id="id3a2" placeholder="название хранилища"/><button onclick="createObjectStore()">открыть</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ b) чтение из хранилище</div>
  <div><input type="input" id="id3b1" placeholder="название базы"/><input type="input" id="id3b2" placeholder="название хранилища"/><input type="input" id="id3b3" placeholder="ключ"/><button onclick="readFromStore()">читать</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ c) запись в хранилище (можно только в созданное хранилище) (только запись)</div>
  <div><input type="input" id="id3c1" placeholder="название базы"/><input type="input" id="id3c2" placeholder="название хранилища"/><input type="input" id="id3c3" placeholder="key"/><input type="input" id="id3c4" placeholder="value"/><button onclick="WriteData()">записать</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ d) запись в хранилище (можно только в созданное хранилище) (запись и перезапись)</div>
  <div><input type="input" id="id3d1" placeholder="название базы"/><input type="input" id="id3d2" placeholder="название хранилища"/><input type="input" id="id3d3" placeholder="key"/><input type="input" id="id3d4" placeholder="value"/><button onclick="WriteAndRewriteData()">перезаписать</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ e) удалить ключ</div>
  <div><input type="input" id="id3e1" placeholder="название базы"/><input type="input" id="id3e2" placeholder="название хранилища"/><input type="input" id="id3e3" placeholder="key"/><button onclick="DeleteKey()">удалить</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ f) удалить хранилище</div>
  <div><input type="input" id="id3f1" placeholder="название базы"/><input type="input" id="id3f2" placeholder="название хранилища"/><button onclick="DeleteStorage()">удалить</button></div>
</div>

<script>
//----
////---- 01 <БАЗОВЫЕ ОПЕРАЦИИ>
//----

  // a) открыть базу (версия должна быть целым числом)
  let openBase = window.indexedDB.open("db", 3);
  console.log('---01a',openBase);

  // b) удалить базу
  let baseDelete = window.indexedDB.deleteDatabase('db1');
  console.log('---01b',baseDelete);

  // c) функция сравнения вернет версий (-1 первый меньше) (0 равный) (1 второй больше)
  console.log('---01c',window.indexedDB.cmp(1,2));

  // d) получить версии
  const DBpromise = window.indexedDB.databases()
  DBpromise.then(databases => {
    console.log('---01d',databases);
  });

  // e) удалить базу
  async function deleteBase(){
    // получаем имя базы
    let baseName = document.getElementById('id1').value;
    console.log('---01e',baseName);
    let DBDeleteRequest = await window.indexedDB.deleteDatabase(baseName);
    console.log('---01e',DBDeleteRequest);
    DBDeleteRequest.onerror = function(event) {
      console.log("---01e Error deleting database",event);
    };
    DBDeleteRequest.onsuccess = function(event) {
      console.log("---01e Database deleted successfully",event);
    };
    DBDeleteRequest.onblocked = function(event) {
      console.log("---01e It's blocked Couldn't delete database due to the operation being blocked",event);
    };
  }

//----
////---- 02 <СТАНДАРТНЫЕ ОПЕРАЦИИ>
//----

  // a) создать или открыть базу

    // получаем имя базы и версию (promise/async)
    function getNameAndVersion(){
     
      // получаем имя базы
      let baseName = document.getElementById('id2a1').value;
    
      // получем версию базы
      const DBpromise = window.indexedDB.databases();
      DBpromise.then(databases => {
        let isFound = false;
        // если база есть - получим версию
        for(let i=0;databases.length>i;i++){
          if(baseName===databases[i].name){
            isFound=true;
            openBaseFunc(baseName,databases[i].version);
          }
        }
        if(!isFound){
          openBaseFunc(baseName,1);
        }
      })
    }
    //открыть или создать базу
    function openBaseFunc(name, version){
      console.log('---02a name', name);
      console.log('---02a version', version);
      

      // откроет или создаст базу
      let openRequest = indexedDB.open(name, version);

      // срабатывает, если на клиенте нет базы данны либо мы поменяли версию
      openRequest.onupgradeneeded = function() {
        console.log("---02a onupgradeneeded", openRequest);
      };

      openRequest.onerror = function() {
        console.log("---02a onerror", openRequest.error);
      };

      openRequest.onsuccess = function() {
        let db = openRequest.result;
        // продолжить работу с базой данных, используя объект db
        console.log("---02a onsuccess", db);
      };
    }

  // b) (закрытие) нужно чтобы удалить (базу / хранилище)
    async function closeBase(){
      // получаем имя базы и хранилища
      let baseName = document.getElementById('id2b1').value;
      
      // получем версию базы
      let version;
      const DBpromise = window.indexedDB.databases();
      await DBpromise.then(databases => {
        // если база есть - получим версию
        for(let i=0;databases.length>i;i++){
          if(baseName===databases[i].name){
            version = databases[i].version;
          }
        }
        if(version===undefined){
          // если база не создана - ставим версию - 1
          version = 1;
        }
      });

      console.log('---02b имя базы',baseName);
      console.log('---02b версия базы',version);

      // откроет или создаст базу
      let openRequest = indexedDB.open(baseName, version);

      // срабатывает, если на клиенте нет базы данны либо мы поменяли версию
      openRequest.onupgradeneeded = function() {
        console.log("---02b onupgradeneeded", openRequest);
      };

      openRequest.onerror = function() {
        console.log("---02b onerror", openRequest.error);
      };

      openRequest.onsuccess = function() {
        let db = openRequest.result;
        // продолжить работу с базой данных, используя объект db
        console.log("---02b onsuccess", db);
        db.close();
        console.log('---wtf in close',close);
        close.onerror = function(event) {
          console.log("---02b onerror",close);
          console.log("---02b onerror",event);
        };
        close.onsuccess = function() {
          console.log("---02b onsuccess",close);
          console.log("---02b onsuccess",event);
        };
      };
    }

//----
////---- 03 <ТРАНЗАКЦИЯ>
//----
  // Транзакция – это группа операций, которые должны быть или все выполнены, или все не выполнены (всё или ничего).

  // a) создать хранилище в уже созданной базе (чтобы создать хранилище нужно обновить версию базы) 
  async function createObjectStore(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3a1').value;
    let objectStoreName = document.getElementById('id3a2').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      if(version===undefined){
        // если база не создана - ставим версию - 1
        version = 1;
      }
    });
    console.log('---03a имя базы',baseName);
    console.log('---03a имя хранилища',objectStoreName);
    console.log('---03a версия базы',version);

    // откроет или создаст базу
    // чтобы создать хранилище нужно обновить версию базы
    let openRequest = indexedDB.open(baseName, version+1);

    // срабатывает, если на клиенте нет базы данны либо мы поменяли версию
    openRequest.onupgradeneeded = function() {
      let db = openRequest.result;
      if (!db.objectStoreNames.contains(objectStoreName)) { // если нет в данной базе такого хранилища
        // objectStoreName - это название хранилища
        // второй аргумент {
        //      keyPath       – путь к свойству объекта, которое IndexedDB будет использовать в качестве ключа, например id.
        //      autoIncrement – если true, то ключ будет формироваться автоматически для новых объектов, как постоянно увеличивающееся число.
        // }
        db.createObjectStore(objectStoreName, {keyPath: 'id'});
      }
    };
    openRequest.onerror = function() {
      console.log("---03a onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---03a onsuccess", db);
    };
    openRequest.onblocked = function(event) {
      console.log("---03a It's blocked Couldn't create",event);
    };
  }
  // b) чтение
  async function readFromStore(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3b1').value;
    let objectStoreName = document.getElementById('id3b2').value;
    let key = document.getElementById('id3b3').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      if(version===undefined){
        // если база не создана - ставим версию - 1
        version = 1;
      }
    });
    console.log('---03b имя базы',baseName);
    console.log('---03b имя хранилища',objectStoreName);
    console.log('---03b версия базы',version);
    console.log('---03b версия базы',key);

    // откроет или создаст базу
    let openRequest = indexedDB.open(baseName, version);

    // срабатывает, если на клиенте нет базы данны либо мы поменяли версию
    openRequest.onupgradeneeded = function() {
      console.log("---03b onupgradeneeded", openRequest);
    };
    openRequest.onerror = function() {
      console.log("---03b onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---03b onsuccess", db);
      
      //перебираем objectStoreNames есть ли такое хранилище
      const array = [ ...db.objectStoreNames ];
      if(!array.includes(objectStoreName)){
        console.log('---03b такого хранилища нету');
        return;
      }

      var transaction = db.transaction(objectStoreName);
      
  
     
      var objectStore = transaction.objectStore(objectStoreName);
      var request = objectStore.get(key);
      request.onerror = function(event) {
        // Handle errors!
        console.log("---03b error",request);
        console.log("---03b error",event);
      };
      request.onsuccess = function() {
        // Do something with the request.result!
        
        if(request.result){
          console.log("---03b answer",request.result);
        }
        else{
          console.log("---03b answer такого ключа нету");
        }
      };

    };

    openRequest.onblocked = function(event) {
      console.log("---03b It's blocked Couldn't create",event);
    };
    
  }
  // c) запись (можно только в созданное хранилище)
  async function WriteData(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3c1').value;
    let objectStoreName = document.getElementById('id3c2').value;
    let key = document.getElementById('id3c3').value;
    let value = document.getElementById('id3c4').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      if(version===undefined){
        // если база не создана - ставим версию - 1
        version = 1;
      }
    });
    console.log('---03с имя базы',baseName);
    console.log('---03с имя хранилища',objectStoreName);
    console.log('---03с версия базы',version);
    console.log('---03с под каким ключом храним',key);
    console.log('---03с что храним',value);

    // откроет или создаст базу
    let openRequest = indexedDB.open(baseName, version);

    // срабатывает, если на клиенте нет базы данны либо мы поменяли версию
    openRequest.onupgradeneeded = function() {
      console.log("---03с onupgradeneeded", openRequest);
    };
    openRequest.onerror = function() {
      console.log("---03с onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---03с onsuccess", db);

      let transaction = db.transaction(objectStoreName, "readwrite");
      // получить хранилище объектов для работы с ним
      let store = transaction.objectStore(objectStoreName);

      let book = {
        id: key,
        data: value,
      };

      let request = store.add(book);
      request.onsuccess = function() {
        console.log("---03с запись добавлена в хранилище", request.result);
      };

      request.onerror = function() {
        console.log("---03с нельзя записывать с таким же id (сначало нужно удалить данный объект)");
      };

    };

    openRequest.onblocked = function(event) {
      console.log("---03с It's blocked Couldn't create",event);
    };
  }

  // d) запись и перезапись 
  async function WriteAndRewriteData(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3d1').value;
    let objectStoreName = document.getElementById('id3d2').value;
    let key = document.getElementById('id3d3').value;
    let value = document.getElementById('id3d4').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      if(version===undefined){
        // если база не создана - ставим версию - 1
        version = 1;
      }
    });
    console.log('---03d имя базы',baseName);
    console.log('---03d имя хранилища',objectStoreName);
    console.log('---03d версия базы',version);
    console.log('---03d под каким ключом храним',key);
    console.log('---03d что храним',value);

    // создаст хранилище объектов, если ешё не существует
    let openRequest = indexedDB.open(baseName, version);

    // срабатывает, если на клиенте нет базы данны либо мы поменяли версию
    openRequest.onupgradeneeded = function() {
      console.log("---03d onupgradeneeded", openRequest);
    };
    openRequest.onerror = function() {
      console.log("---03d onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---03d onsuccess", db);
      
      var request = db.transaction(objectStoreName, "readwrite")
                      .objectStore(objectStoreName)
                      .delete(key);
      request.onsuccess = function(event) {
        // It's gone!
        console.log("---DONE",event);
        let db = openRequest.result;
        // продолжить работу с базой данных, используя объект db
        console.log("---03d onsuccess", db);

        let transaction = db.transaction(objectStoreName, "readwrite");
        // получить хранилище объектов для работы с ним
        let store = transaction.objectStore(objectStoreName);

        let book = {
          id: key,
          data: value,
        };

        let request = store.add(book);
        request.onsuccess = function() {
          console.log("---03d запись добавлена в хранилище", request.result);
        };

        request.onerror = function() {
          console.log("---03d ошибка");
        };
      };


    };

    openRequest.onblocked = function(event) {
      console.log("---03b It's blocked Couldn't create",event);
    };

  }

  // e) удалить ключ
  async function DeleteKey(){
      // получаем имя базы и хранилища
      let baseName = document.getElementById('id3e1').value;
      let objectStoreName = document.getElementById('id3e2').value;
      let key = document.getElementById('id3e3').value;

      // получем версию базы
      let version;
      const DBpromise = window.indexedDB.databases();
      await DBpromise.then(databases => {
        // если база есть - получим версию
        for(let i=0;databases.length>i;i++){
          if(baseName===databases[i].name){
            version = databases[i].version;
          }
        }
        if(version===undefined){
          // если база не создана - ставим версию - 1
          version = 1;
        }
        
      });
      console.log('---03e имя базы',baseName);
      console.log('---03e имя хранилища',objectStoreName);
      console.log('---03e ключ',key);
      console.log('---03e версия базы',version);


      // откроет или создаст базу
      let openRequest = indexedDB.open(baseName, version);

      // срабатывает, если на клиенте нет базы данны либо мы поменяли версию
      openRequest.onupgradeneeded = function() {
        console.log("---03e onupgradeneeded", openRequest);
      };
      openRequest.onerror = function() {
        console.log("---03e onerror", openRequest.error);
      };

      openRequest.onsuccess = function() {
        let db = openRequest.result;
        // продолжить работу с базой данных, используя объект db
        console.log("---03e onsuccess", db);

        let transaction = db.transaction(objectStoreName, "readwrite");
        // получить хранилище объектов для работы с ним
        let store = transaction.objectStore(objectStoreName);

        let request = store.delete(key);

        request.onsuccess = function() {
          console.log("---03e запись удалена в хранилище", request);
        };

        request.onerror = function() {
          console.log("---03e нельзя записывать с таким же id (сначало нужно удалить данный объект)");
      };
      };
      openRequest.onblocked = function(event) {
        console.log("---03e It's blocked Couldn't delete",event);
      };
      
    }
    
  // f) удалить хранилище
  async function DeleteStorage(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3f1').value;
    let objectStoreName = document.getElementById('id3f2').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      if(version===undefined){
        // если база не создана - ставим версию - 1
        version = 1;
      }
      
    });
    console.log('---03e имя базы',baseName);
    console.log('---03e имя хранилища',objectStoreName);
    console.log('---03e версия базы',version);


    // откроет или создаст базу
    // чтобы удалить хранилище нужно обновить версию базы
    let openRequest = indexedDB.open(baseName, version+1);

    // срабатывает, если на клиенте нет базы данны либо мы поменяли версию
    openRequest.onupgradeneeded = function() {
      let db = openRequest.result;
      if (db.objectStoreNames.contains(objectStoreName)) { // есть ли в в данной базе такое хранилище
        // objectStoreName - это название хранилища
        db.deleteObjectStore(objectStoreName);
      }
    };
    openRequest.onerror = function() {
      console.log("---03e onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---03e onsuccess", db);
    };
    openRequest.onblocked = function(event) {
      console.log("---03e It's blocked Couldn't delete",event);
    };
    
  }


</script>	
<body>
	
</body>
</html>