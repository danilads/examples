<!DOCTYPE html> 
<html>
<head>
	<meta charset="utf-8" />
	<title></title>
</head>
<body>
<div>
  <div>01 УДАЛИТЬ БАЗУ</div>
  <div><input type="input" id="id1" placeholder="название базы"/><button onclick="deleteBase()">удалить</button></div>
</div>
<br/>
<div>
  <div>02 СТАНДАРТНЫЙ КОНСТРУКТОР (создание / открытие)</div>
  <div><input type="input" id="id2" placeholder="название базы"/><button onclick="getNameAndVersion()">создание / открытие</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ a) создать хранилище</div>
  <div><input type="input" id="id3a1" placeholder="название базы"/><input type="input" id="id3a2" placeholder="название хранилища"/><button onclick="createObjectStore()">открыть</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ b) чтение из хранилище</div>
  <div><input type="input" id="id3b1" placeholder="название базы"/><input type="input" id="id3b2" placeholder="название хранилища"/><input type="input" id="id3b3" placeholder="ключ"/><button onclick="readFromStore()">читать</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ c) запись в хранилище (можно только в созданное хранилище) (только запись)</div>
  <div><input type="input" id="id3c1" placeholder="название базы"/><input type="input" id="id3c2" placeholder="название хранилища"/><input type="input" id="id3c3" placeholder="key"/><input type="input" id="id3c4" placeholder="value"/><button onclick="WriteData()">записать</button></div>
</div>
<br/>
<div>
  <div>03 ТРАНЗАКЦИЯ d) запись в хранилище (можно только в созданное хранилище) (запись и перезапись)</div>
  <div><input type="input" id="id3d1" placeholder="название базы"/><input type="input" id="id3d2" placeholder="название хранилища"/><input type="input" id="id3d3" placeholder="key"/><input type="input" id="id3d4" placeholder="value"/><button onclick="WriteAndRewriteData()">записать</button></div>
</div>

<script>
//----
////---- 01 <БАЗОВЫЕ ОПЕРАЦИИ>
//----

  // a) открыть базу (версия должна быть целым числом)
  let openBase = window.indexedDB.open("db", 3);
  console.log('---01a',openBase);

  // b) удалить базу
  let baseDelete = window.indexedDB.deleteDatabase('db1');
  console.log('---01b',baseDelete);

  // c) функция сравнения вернет версий (-1 первый меньше) (0 равный) (1 второй больше)
  console.log('---01c',window.indexedDB.cmp(1,2));

  // d) получить версии
  const DBpromise = window.indexedDB.databases()
  DBpromise.then(databases => {
    console.log('---01d',databases);
  });

  // e) удалить базу
  function deleteBase(){
    // получаем имя базы
    let baseName = document.getElementById('id1').value;

    var DBDeleteRequest = window.indexedDB.deleteDatabase(baseName);

    DBDeleteRequest.onerror = function(event) {
      console.log("---01e Error deleting database",event);
    };
    DBDeleteRequest.onsuccess = function(event) {
      console.log("---01e Database deleted successfully",event);
    };
    DBDeleteRequest.onblocked = function(event) {
      console.log("---01e Couldn't delete database due to the operation being blocked",event);
    };
  }

//----
////---- 02 <СТАНДАРТНЫЙ КОНСТРУКТОР>
//----

  // создать или открыть базу

  // a) получаем имя базы и версию (promise/async)
  function getNameAndVersion(){
    // получаем имя базы
    let baseName = document.getElementById('id2').value;

    // получем версию базы
    const DBpromise = window.indexedDB.databases();
    DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          openBaseFunc(baseName,databases[i].version);
        }
      }
      // если база не создана - ставим версию - 1
      openBaseFunc(baseName,1);

    })
  }

  // b) конструктор
  function openBaseFunc(name, version){
    console.log('---02b name', name);
    console.log('---02b version', version);

    let openRequest = indexedDB.open(name, version);

    openRequest.onupgradeneeded = function() {
      // срабатывает, если на клиенте нет базы данных
      // ...выполнить инициализацию...
      console.log("---2b onupgradeneeded", openRequest);
    };

    openRequest.onerror = function() {
      console.log("---2b onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---2b onsuccess", db);
    };
  }

//----
////---- 03 <ТРАНЗАКЦИЯ>
//----
  // Транзакция – это группа операций, которые должны быть или все выполнены, или все не выполнены (всё или ничего).

  // a) создать хранилище
  async function createObjectStore(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3a1').value;
    let objectStoreName = document.getElementById('id3a2').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      // если база не создана - ставим версию - 1
      version = 1;
    });
    console.log('---3a имя базы',baseName);
    console.log('---3a имя хранилища',objectStoreName);
    console.log('---3a версия базы',version);

    let openRequest = indexedDB.open(baseName, version);

    // создаём хранилище объектов для books, если ешё не существует
    openRequest.onupgradeneeded = function() {
      let db = openRequest.result;
      if (!db.objectStoreNames.contains(objectStoreName)) { // if there's no "books" store
        // objectStoreName - это название хранилища
        // второй аргумент {
        //      keyPath       – путь к свойству объекта, которое IndexedDB будет использовать в качестве ключа, например id.
        //      autoIncrement – если true, то ключ будет формироваться автоматически для новых объектов, как постоянно увеличивающееся число.
        // }
        db.createObjectStore(objectStoreName, {keyPath: 'id'});
      }
    };
    openRequest.onerror = function() {
      console.log("---03a onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---03a onsuccess", db);
    };
    openRequest.onblocked = function(event) {
      console.log("---03a Couldn't create",event);
    };
  }
  // b) чтение
  async function readFromStore(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3b1').value;
    let objectStoreName = document.getElementById('id3b2').value;
    let key = document.getElementById('id3b3').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      // если база не создана - ставим версию - 1
      version = 1;
    });
    console.log('---3b имя базы',baseName);
    console.log('---3b имя хранилища',objectStoreName);
    console.log('---3b версия базы',version);
    console.log('---3b версия базы',key);

    let openRequest = indexedDB.open(baseName, version);

    // создаём хранилище объектов, если ешё не существует
    openRequest.onupgradeneeded = function() {
       // срабатывает, если на клиенте нет базы данных
      // ...выполнить инициализацию...
      console.log("---03b onupgradeneeded", openRequest);
    };
    openRequest.onerror = function() {
      console.log("---03b onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---03b onsuccess", db);
      
      //перебираем objectStoreNames есть ли такое хранилище
      const array = [ ...db.objectStoreNames ];
      if(!array.includes(objectStoreName)){
        console.log('---03b такого хранилища нету');
        return;
      }

      var transaction = db.transaction(objectStoreName);
      
  
     
      var objectStore = transaction.objectStore(objectStoreName);
      var request = objectStore.get(key);
      request.onerror = function(event) {
        // Handle errors!
        console.log("---03b error",request);
        console.log("---03b error",event);
      };
      request.onsuccess = function() {
        // Do something with the request.result!
        
        if(request.result){
          console.log("---03b answer",request.result);
        }
        else{
          console.log("---03b answer такого ключа нету");
        }
      };

    };

    openRequest.onblocked = function(event) {
      console.log("---03b Couldn't create",event);
    };
    
  }
  // c) запись (можно только в созданное хранилище)
  async function WriteData(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3c1').value;
    let objectStoreName = document.getElementById('id3c2').value;
    let key = document.getElementById('id3c3').value;
    let value = document.getElementById('id3c4').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      // если база не создана - ставим версию - 1
      version = 1;
    });
    console.log('---3с имя базы',baseName);
    console.log('---3с имя хранилища',objectStoreName);
    console.log('---3с версия базы',version);
    console.log('---3с под каким ключом храним',key);
    console.log('---3с что храним',value);

    let openRequest = indexedDB.open(baseName, version);

    // создаём хранилище объектов, если ешё не существует
    openRequest.onupgradeneeded = function() {
       // срабатывает, если на клиенте нет базы данных
      // ...выполнить инициализацию...
      console.log("---03с onupgradeneeded", openRequest);
    };
    openRequest.onerror = function() {
      console.log("---03с onerror", openRequest.error);
    };

    openRequest.onsuccess = function() {
      let db = openRequest.result;
      // продолжить работу с базой данных, используя объект db
      console.log("---03с onsuccess", db);

      let transaction = db.transaction(objectStoreName, "readwrite");
      // получить хранилище объектов для работы с ним
      let store = transaction.objectStore(objectStoreName);

      let book = {
        id: key,
        data: value,
      };

      let request = store.add(book);
      request.onsuccess = function() {
        console.log("---03с запись добавлена в хранилище", request.result);
      };

      request.onerror = function() {
        console.log("---03с нельзя записывать с таким же id");
      };

    };

    openRequest.onblocked = function(event) {
      console.log("---03с Couldn't create",event);
    };
  }

  // d) запись и перезапись 
  async function WriteAndRewriteData(){
    // получаем имя базы и хранилища
    let baseName = document.getElementById('id3d1').value;
    let objectStoreName = document.getElementById('id3d2').value;
    let key = document.getElementById('id3d3').value;
    let value = document.getElementById('id3d4').value;
    
    // получем версию базы
    let version;
    const DBpromise = window.indexedDB.databases();
    await DBpromise.then(databases => {
      // если база есть - получим версию
      for(let i=0;databases.length>i;i++){
        if(baseName===databases[i].name){
          version = databases[i].version;
        }
      }
      // если база не создана - ставим версию - 1
      version = 1;
    });
    console.log('---3d имя базы',baseName);
    console.log('---3d имя хранилища',objectStoreName);
    console.log('---3d версия базы',version);
    console.log('---3d под каким ключом храним',key);
    console.log('---3d что храним',value);


  }


</script>	
<body>
	
</body>
</html>